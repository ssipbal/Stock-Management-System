<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NFC Smart Inventory Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Sarabun', sans-serif;
      background: #eef3f7;
      color: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      max-width: 480px;
      width: 100%;
      padding: 30px;
      text-align: center;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    label {
      display: block;
      text-align: left;
      margin-top: 15px;
      margin-bottom: 5px;
      font-weight: 600;
      font-size: 14px;
    }
    input, select {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-bottom: 10px;
      font-family: 'Sarabun', sans-serif;
    }
    button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background-color: #007acc;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
      margin-top: 10px;
    }
    button:hover {
      background-color: #005fa3;
    }
    #response {
      margin-top: 15px;
      font-size: 14px;
      font-weight: 500;
      color: green;
    }
    #stock-list {
      padding-left: 0;
      list-style: none;
      text-align: left;
      font-size: 15px;
      margin-bottom: 20px;
      max-height: 200px;
      overflow-y: auto;
    }
    #stock-list li {
      margin-bottom: 4px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      font-size: 14px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    .hidden {
      display: none;
    }
    .big-total {
      font-weight: 700;
      font-size: 22px;
      margin-top: 20px;
      text-align: right;
    }
    .small-button {
      width: auto;
      padding: 6px 10px;
      font-size: 13px;
      background-color: #cc0000;
      margin-left: 5px;
      border-radius: 5px;
    }
    @media (max-width: 500px) {
      .container {
        padding: 20px;
      }
      h1 {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container" id="mainMenu">
    <h1>NFC Smart Inventory Management System</h1>
    <button id="btnCustomer">Customer</button>
    <button id="btnAdmin">Admin</button>
  </div>

  <!-- Admin Login -->
  <div class="container hidden" id="adminLogin">
    <h1>Admin Login</h1>
    <label for="adminPassword">Enter Password:</label>
    <input type="password" id="adminPassword" />
    <button id="adminLoginSubmit">Login</button>
    <button id="adminLoginBack">Back</button>
    <p id="adminLoginResponse" style="color:red;"></p>
  </div>

  <!-- Admin Dashboard -->
  <div class="container hidden" id="adminDashboard">
    <h1>Admin Dashboard</h1>
    <button id="showStockBtn">View Live Stock</button>
    <button id="showOrderHistoryBtn">View Order History</button>
    <button id="adminLogoutBtn">Logout</button>

    <div id="liveStockSection" class="hidden">
      <h3>Current Stock</h3>
      <ul id="stock-list"><li>Loading...</li></ul>
      <button id="backToMenuFromStock">Back to Menu</button>
    </div>

    <div id="orderHistorySection" class="hidden">
      <h3>Order History</h3>
      <table id="orderHistoryTable">
        <thead>
          <tr><th>Timestamp</th><th>Items</th><th>Quantities</th><th>Total Price (THB)</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <button id="backToMenuFromHistory">Back to Menu</button>
    </div>
  </div>

  <!-- Customer Page -->
  <div class="container hidden" id="customerPage">
    <h1>Customer Order</h1>

    <form id="customerForm">
      <label for="item">Item</label>
      <select id="item" name="item" required>
        <option value="Cookie">Cookie</option>
        <option value="Brownie">Brownie</option>
        <option value="Macaron">Macaron</option>
      </select>

      <label for="quantity">Quantity</label>
      <input type="number" id="quantity" name="quantity" min="1" required />

      <label for="action">Action</label>
      <select id="action" name="action" required>
        <option value="Add">Add</option>
      </select>

      <button type="submit">Add to Summary</button>
    </form>

    <h3>Order Summary</h3>
    <table id="orderSummaryTable">
      <thead>
        <tr><th>Item</th><th>Quantity</th><th>Price (THB)</th><th>Action</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="big-total" id="totalPriceDisplay">Total: 0 THB</div>

    <button id="confirmOrderBtn">Confirm Order</button>
    <button id="backToMenuFromCustomer">Back to Main Menu</button>

    <p id="customerResponse"></p>
  </div>

  <script>
    const stockURL = 'https://script.google.com/macros/s/YOUR_DEPLOYED_SCRIPT_ID/exec'; // <-- Replace with your actual Apps Script URL

    // Pricing per item
    const prices = {
      "Cookie": 15,
      "Brownie": 20,
      "Macaron": 35
    };

    // Cached DOM elements
    const mainMenu = document.getElementById('mainMenu');
    const btnCustomer = document.getElementById('btnCustomer');
    const btnAdmin = document.getElementById('btnAdmin');

    // Admin login
    const adminLogin = document.getElementById('adminLogin');
    const adminPassword = document.getElementById('adminPassword');
    const adminLoginSubmit = document.getElementById('adminLoginSubmit');
    const adminLoginBack = document.getElementById('adminLoginBack');
    const adminLoginResponse = document.getElementById('adminLoginResponse');

    // Admin dashboard
    const adminDashboard = document.getElementById('adminDashboard');
    const showStockBtn = document.getElementById('showStockBtn');
    const showOrderHistoryBtn = document.getElementById('showOrderHistoryBtn');
    const adminLogoutBtn = document.getElementById('adminLogoutBtn');
    const liveStockSection = document.getElementById('liveStockSection');
    const stockList = document.getElementById('stock-list');
    const backToMenuFromStock = document.getElementById('backToMenuFromStock');
    const orderHistorySection = document.getElementById('orderHistorySection');
    const orderHistoryTableBody = document.querySelector('#orderHistoryTable tbody');
    const backToMenuFromHistory = document.getElementById('backToMenuFromHistory');

    // Customer page
    const customerPage = document.getElementById('customerPage');
    const customerForm = document.getElementById('customerForm');
    const orderSummaryTableBody = document.querySelector('#orderSummaryTable tbody');
    const totalPriceDisplay = document.getElementById('totalPriceDisplay');
    const confirmOrderBtn = document.getElementById('confirmOrderBtn');
    const backToMenuFromCustomer = document.getElementById('backToMenuFromCustomer');
    const customerResponse = document.getElementById('customerResponse');

    // Current order summary (array of objects)
    let orderSummary = [];

    // --- Navigation functions ---

    function showElement(el) {
      el.classList.remove('hidden');
    }
    function hideElement(el) {
      el.classList.add('hidden');
    }
    function showMainMenu() {
      hideElement(adminLogin);
      hideElement(adminDashboard);
      hideElement(customerPage);
      showElement(mainMenu);
      adminPassword.value = '';
      adminLoginResponse.textContent = '';
      orderSummary = [];
      clearOrderSummaryTable();
      customerResponse.textContent = '';
    }
    function showAdminLogin() {
      hideElement(mainMenu);
      showElement(adminLogin);
      adminPassword.value = '';
      adminLoginResponse.textContent = '';
    }
    function showAdminDashboard() {
      hideElement(adminLogin);
      hideElement(mainMenu);
      hideElement(customerPage);
      showElement(adminDashboard);
      hideElement(liveStockSection);
      hideElement(orderHistorySection);
      loadLiveStock();
    }
    function showCustomerPage() {
      hideElement(mainMenu);
      hideElement(adminDashboard);
      hideElement(adminLogin);
      showElement(customerPage);
      orderSummary = [];
      clearOrderSummaryTable();
      updateTotalPrice();
      customerResponse.textContent = '';
    }

    // --- Admin Login ---
    btnAdmin.addEventListener('click', showAdminLogin);
    adminLoginBack.addEventListener('click', showMainMenu);

    adminLoginSubmit.addEventListener('click', () => {
      const pass = adminPassword.value;
      if (pass === '12345') {
        showAdminDashboard();
      } else {
        adminLoginResponse.textContent = 'Incorrect password.';
      }
    });

    // --- Admin Dashboard ---
    showStockBtn.addEventListener('click', () => {
      showElement(liveStockSection);
      hideElement(orderHistorySection);
      loadLiveStock();
    });

    backToMenuFromStock.addEventListener('click', () => {
      hideElement(liveStockSection);
    });

    showOrderHistoryBtn.addEventListener('click', () => {
      hideElement(liveStockSection);
      showElement(orderHistorySection);
      loadOrderHistory();
    });

    backToMenuFromHistory.addEventListener('click', () => {
      hideElement(orderHistorySection);
    });

    adminLogoutBtn.addEventListener('click', showMainMenu);

    // --- Live Stock for Admin ---
    async function loadLiveStock() {
      stockList.innerHTML = '<li>Loading...</li>';
      try {
        const res = await fetch(stockURL);
        if (!res.ok) throw new Error('Failed to fetch stock');
        const data = await res.json();
        stockList.innerHTML = '';
        for (const key in data.stock) {
          const li = document.createElement('li');
          li.textContent = `${key}: ${data.stock[key]}`;
          stockList.appendChild(li);
        }
      } catch (err) {
        stockList.innerHTML = '<li>Failed to load stock.</li>';
        console.error(err);
      }
    }

    // --- Load Order History ---
    async function loadOrderHistory() {
      orderHistoryTableBody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
      try {
        const res = await fetch(stockURL + '?history=true');
        if (!res.ok) throw new Error('Failed to fetch order history');
        const orders = await res.json();
        orderHistoryTableBody.innerHTML = '';
        if (!orders.length) {
          orderHistoryTableBody.innerHTML = '<tr><td colspan="4">No orders found.</td></tr>';
          return;
        }
        orders.forEach(order => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${new Date(order.timestamp).toLocaleString()}</td>
            <td>${order.items.join(', ')}</td>
            <td>${order.quantities.join(', ')}</td>
            <td>${order.totalPrice}</td>
          `;
          orderHistoryTableBody.appendChild(row);
        });
      } catch (err) {
        orderHistoryTableBody.innerHTML = '<tr><td colspan="4">Failed to load order history.</td></tr>';
        console.error(err);
      }
    }

    // --- Customer Page ---

    // Clear order summary table
    function clearOrderSummaryTable() {
      orderSummaryTableBody.innerHTML = '';
    }

    // Update total price display
    function updateTotalPrice() {
      const total = orderSummary.reduce((sum, o) => sum + o.quantity * prices[o.item], 0);
      totalPriceDisplay.textContent = `Total: ${total} THB`;
    }

    // Add order to summary table and array
    function addOrderToSummary(item, quantity) {
      // Check if item exists, if so increase quantity
      const existing = orderSummary.find(o => o.item === item);
      if (existing) {
        existing.quantity += quantity;
      } else {
        orderSummary.push({item, quantity});
      }
      renderOrderSummaryTable();
      updateTotalPrice();
    }

    // Render order summary table rows
    function renderOrderSummaryTable() {
      clearOrderSummaryTable();
      orderSummary.forEach((order, index) => {
        const row = document.createElement('tr');
        const price = order.quantity * prices[order.item];
        row.innerHTML = `
          <td>${order.item}</td>
          <td>${order.quantity}</td>
          <td>${price}</td>
          <td><button class="small-button" data-index="${index}">Delete</button></td>
        `;
        orderSummaryTableBody.appendChild(row);
      });

      // Attach delete handlers
      const deleteButtons = orderSummaryTableBody.querySelectorAll('button.small-button');
      deleteButtons.forEach(btn => {
        btn.onclick = () => {
          const i = parseInt(btn.getAttribute('data-index'));
          orderSummary.splice(i, 1);
          renderOrderSummaryTable();
          updateTotalPrice();
        };
      });
    }

    // Handle customer form submit to add order
    customerForm.addEventListener('submit', e => {
      e.preventDefault();
      const item = customerForm.item.value;
      const quantity = Number(customerForm.quantity.value);
      if (quantity < 1) return alert("Quantity must be at least 1.");
      addOrderToSummary(item, quantity);
      customerForm.reset();
      customerForm.action.value = "Add"; // Reset to Add (though only Add option exists now)
    });

    // Confirm order button handler
    confirmOrderBtn.addEventListener('click', async () => {
      if (orderSummary.length === 0) {
        customerResponse.textContent = 'No items to confirm.';
        return;
      }
      customerResponse.textContent = 'Submitting order...';
      try {
        // Prepare requests for each item to remove quantities from stock
        // We use action=Remove here to deduct stock
        for (const order of orderSummary) {
          const url = `${stockURL}?item=${encodeURIComponent(order.item)}&action=Remove&quantity=${encodeURIComponent(order.quantity)}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error(`Failed to update stock for ${order.item}`);
          await res.json();
        }
        customerResponse.style.color = 'green';
        customerResponse.textContent = 'Order confirmed successfully!';
        orderSummary = [];
        renderOrderSummaryTable();
        updateTotalPrice();
      } catch (err) {
        customerResponse.style.color = 'red';
        customerResponse.textContent = 'Failed to confirm order: ' + err.message;
        console.error(err);
      }
    });

    // Back buttons
    backToMenuFromCustomer.addEventListener('click', showMainMenu);
    backToMenuFromStock.addEventListener('click', () => {
      hideElement(liveStockSection);
    });
    backToMenuFromHistory.addEventListener('click', () => {
      hideElement(orderHistorySection);
    });

    // Customer button handler
    btnCustomer.addEventListener('click', showCustomerPage);

    // Helper for hiding/showing
    // Already defined showElement/hideElement

    // Initialize to main menu on load
    showMainMenu();

  </script>
</body>
</html>
