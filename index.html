<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NFC Inventory System</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      text-align: center;
      padding: 20px;
    }
    button {
      padding: 10px 20px;
      margin: 10px;
      font-size: 18px;
      border-radius: 8px;
    }
    .hidden { display: none; }
    table { margin: auto; margin-top: 20px; border-collapse: collapse; }
    td, th { border: 1px solid #ccc; padding: 8px 12px; }
    input[type="number"] { width: 60px; }
    .popup {
      position: fixed;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -30%);
      background: #fff;
      padding: 20px;
      border: 2px solid #000;
      z-index: 1000;
    }
  </style>
</head>
<body>

<div id="main">
  <h1>NFC Inventory System</h1>
  <button onclick="location.href='?mode=customer'">Customer</button>
  <button onclick="askPassword()">Admin</button>
</div>

<div id="customer" class="hidden">
  <h2>Customer Page</h2>
  <button onclick="scanTag()">Scan Product (NFC)</button>
  <table id="summary">
    <tr><th>Product</th><th>Quantity</th><th>Price</th><th>Action</th></tr>
  </table>
  <button onclick="submitOrder()">Submit Order</button>
</div>

<div id="admin" class="hidden">
  <h2>Admin Page</h2>
  <div>
    <h3>Current Stock</h3>
    <ul id="stockList"></ul>
  </div>
  <div>
    <h3>Add Stock</h3>
    <select id="addItem">
      <option>Cleanser</option><option>Toner</option><option>Serum</option>
    </select>
    <input type="number" id="addQty" placeholder="Quantity">
    <button onclick="changeStock('add')">Add</button>
  </div>
  <div>
    <h3>Remove Stock</h3>
    <select id="removeItem">
      <option>Cleanser</option><option>Toner</option><option>Serum</option>
    </select>
    <input type="number" id="removeQty" placeholder="Quantity">
    <button onclick="changeStock('remove')">Remove</button>
  </div>
  <button onclick="location.href='?mode=server'">View Server Log</button>
</div>

<div id="receipt" class="hidden">
  <h2>Receipt</h2>
  <p id="orderNumber"></p>
  <table id="receiptTable">
    <tr><th>Product</th><th>Qty</th><th>Price</th></tr>
  </table>
  <p id="totalPrice"></p>
  <button onclick="location.href='?mode=customer'">Back to Customer</button>
</div>

<div id="server" class="hidden">
  <h2>Server Log</h2>
  <ul id="logList"></ul>
  <button onclick="location.href='?mode=admin'">Back to Admin</button>
</div>

<div id="popup" class="popup hidden">
  <p id="popupProduct"></p>
  Quantity: <input type="number" id="popupQty">
  <button onclick="addToSummary()">Add</button>
</div>

<script>
const productMap = {
  "04:A1:1F:89:32:02:89": { name: "Cleanser", price: 10 },
  "04:F1:45:8B:32:02:89": { name: "Toner", price: 15 },
  "04:81:6B:94:32:02:89": { name: "Serum", price: 20 }
};
let order = [], currentProduct = null;

function askPassword() {
  const pass = prompt("Enter Admin Password:");
  if (pass === "12345") location.href = "?mode=admin";
}

function scanTag() {
  if (!("NDEFReader" in window)) return alert("NFC not supported.");
  const reader = new NDEFReader();
  reader.scan().then(() => {
    reader.onreading = (e) => {
      const id = Array.from(e.serialNumber).map(c => c.charCodeAt(0).toString(16).padStart(2, '0').toUpperCase()).join(':');
      const prod = productMap[id];
      if (!prod) return alert("Unknown tag: " + id);
      currentProduct = prod;
      document.getElementById("popupProduct").innerText = `Product: ${prod.name} - ฿${prod.price}`;
      document.getElementById("popupQty").value = 1;
      document.getElementById("popup").classList.remove("hidden");
    };
  });
}

function addToSummary() {
  const qty = parseInt(document.getElementById("popupQty").value);
  if (qty > 0) order.push({ ...currentProduct, qty });
  document.getElementById("popup").classList.add("hidden");
  renderSummary();
}

function renderSummary() {
  const table = document.getElementById("summary");
  table.innerHTML = "<tr><th>Product</th><th>Qty</th><th>Price</th><th>Action</th></tr>";
  order.forEach((item, i) => {
    table.innerHTML += `<tr>
      <td>${item.name}</td>
      <td>${item.qty}</td>
      <td>฿${item.price * item.qty}</td>
      <td><button onclick="editItem(${i})">Edit</button><button onclick="delItem(${i})">Delete</button></td>
    </tr>`;
  });
}

function editItem(i) {
  const newQty = prompt("New quantity:", order[i].qty);
  if (newQty > 0) order[i].qty = parseInt(newQty);
  renderSummary();
}

function delItem(i) {
  order.splice(i, 1);
  renderSummary();
}

function submitOrder() {
  if (!order.length) return alert("Order is empty!");
  const stock = JSON.parse(localStorage.getItem("stock") || "{}");
  order.forEach(item => {
    stock[item.name] = (stock[item.name] || 0) - item.qty;
  });
  localStorage.setItem("stock", JSON.stringify(stock));
  const logs = JSON.parse(localStorage.getItem("logs") || "[]");
  const now = new Date();
  const orderNum = getOrderNumber();
  logs.push({ type: "order", time: now.toISOString(), details: [...order], orderNum });
  localStorage.setItem("logs", JSON.stringify(cleanLogs(logs)));
  showReceipt(orderNum);
  order = [];
  renderSummary();
}

function getOrderNumber() {
  const today = new Date().toDateString();
  const last = JSON.parse(localStorage.getItem("lastOrder") || "{}");
  if (last.date !== today) {
    localStorage.setItem("lastOrder", JSON.stringify({ date: today, num: 1 }));
    return "Order #001";
  } else {
    const newNum = last.num + 1;
    localStorage.setItem("lastOrder", JSON.stringify({ date: today, num: newNum }));
    return `Order #${String(newNum).padStart(3, '0')}`;
  }
}

function showReceipt(orderNum) {
  document.getElementById("orderNumber").innerText = orderNum;
  const table = document.getElementById("receiptTable");
  table.innerHTML = "<tr><th>Product</th><th>Qty</th><th>Price</th></tr>";
  let total = 0;
  order.forEach(item => {
    table.innerHTML += `<tr><td>${item.name}</td><td>${item.qty}</td><td>฿${item.qty * item.price}</td></tr>`;
    total += item.qty * item.price;
  });
  document.getElementById("totalPrice").innerText = `Total: ฿${total}`;
  show("receipt");
}

function changeStock(type) {
  const item = document.getElementById(type + "Item").value;
  const qty = parseInt(document.getElementById(type + "Qty").value);
  const stock = JSON.parse(localStorage.getItem("stock") || "{}");
  stock[item] = (stock[item] || 0) + (type === "add" ? qty : -qty);
  localStorage.setItem("stock", JSON.stringify(stock));
  const logs = JSON.parse(localStorage.getItem("logs") || "[]");
  logs.push({ type: type, time: new Date().toISOString(), details: `${item}: ${qty}` });
  localStorage.setItem("logs", JSON.stringify(cleanLogs(logs)));
  renderStock();
}

function renderStock() {
  const stock = JSON.parse(localStorage.getItem("stock") || "{}");
  const ul = document.getElementById("stockList");
  ul.innerHTML = "";
  ["Cleanser", "Toner", "Serum"].forEach(name => {
    ul.innerHTML += `<li>${name}: ${stock[name] || 0}</li>`;
  });
}

function cleanLogs(logs) {
  const twoDays = Date.now() - 2 * 24 * 60 * 60 * 1000;
  return logs.filter(log => new Date(log.time).getTime() >= twoDays);
}

function renderLogs() {
  const logs = JSON.parse(localStorage.getItem("logs") || "[]");
  const list = document.getElementById("logList");
  list.innerHTML = "";
  logs.forEach(log => {
    list.innerHTML += `<li>[${new Date(log.time).toLocaleString()}] ${log.type.toUpperCase()} → ${JSON.stringify(log.details)}</li>`;
  });
}

function show(section) {
  ["main", "customer", "admin", "receipt", "server"].forEach(id => {
    document.getElementById(id).classList.add("hidden");
  });
  document.getElementById(section).classList.remove("hidden");
}

window.onload = () => {
  const mode = new URLSearchParams(location.search).get("mode");
  if (mode === "customer") show("customer");
  else if (mode === "admin") { show("admin"); renderStock(); }
  else if (mode === "server") { show("server"); renderLogs(); }
};
</script>
</body>
</html>
